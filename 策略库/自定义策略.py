"""
é‚¢ä¸è¡Œï½œç­–ç•¥åˆ†äº«ä¼š
é€‰è‚¡ç­–ç•¥æ¡†æ¶ğ“Ÿğ“»ğ“¸

ç‰ˆæƒæ‰€æœ‰ Â©ï¸ é‚¢ä¸è¡Œ
å¾®ä¿¡: xbx1717

æœ¬ä»£ç ä»…ä¾›ä¸ªäººå­¦ä¹ ä½¿ç”¨ï¼Œæœªç»æˆæƒä¸å¾—å¤åˆ¶ã€ä¿®æ”¹æˆ–ç”¨äºå•†ä¸šç”¨é€”ã€‚

Author: é‚¢ä¸è¡Œ
"""
import pandas as pd


def filter_stock(df, strategy) -> pd.DataFrame:
    """
    è¿‡æ»¤å‡½æ•°ï¼Œåœ¨é€‰è‚¡å‰è¿‡æ»¤
    :param df: æ•´ç†å¥½çš„æ•°æ®ï¼ŒåŒ…å«å› å­ä¿¡æ¯ï¼Œå¹¶åšè¿‡å‘¨æœŸè½¬æ¢
    :param strategy: ç­–ç•¥é…ç½®
    :return: è¿”å›è¿‡æ»¤åçš„æ•°æ®
    """
    # åˆ é™¤æœˆæœ«ä¸ºstçŠ¶æ€çš„å‘¨æœŸæ•°
    cond1 = ~df['è‚¡ç¥¨åç§°'].str.contains('ST', regex=False)
    # åˆ é™¤æœˆæœ«ä¸ºsçŠ¶æ€çš„å‘¨æœŸæ•°
    cond2 = ~df['è‚¡ç¥¨åç§°'].str.contains('S', regex=False)
    # åˆ é™¤æœˆæœ«æœ‰é€€å¸‚é£é™©çš„å‘¨æœŸæ•°
    cond3 = ~df['è‚¡ç¥¨åç§°'].str.contains('*', regex=False)
    cond4 = ~df['è‚¡ç¥¨åç§°'].str.contains('é€€', regex=False)
    # åˆ é™¤äº¤æ˜“å¤©æ•°è¿‡å°‘çš„å‘¨æœŸæ•°
    # cond5 = df['äº¤æ˜“å¤©æ•°'] / df['å¸‚åœºäº¤æ˜“å¤©æ•°'] >= 0.8

    cond6 = df['ä¸‹æ—¥_æ˜¯å¦äº¤æ˜“'] == 1
    cond7 = df['ä¸‹æ—¥_å¼€ç›˜æ¶¨åœ'] != 1
    cond8 = df['ä¸‹æ—¥_æ˜¯å¦ST'] != 1
    cond9 = df['ä¸‹æ—¥_æ˜¯å¦é€€å¸‚'] != 1
    # cond10 = df['ä¸Šå¸‚è‡³ä»Šäº¤æ˜“å¤©æ•°'] > days_listed
    
    # æ£€æŸ¥æ²ªæ·±300æˆåˆ†è‚¡åˆ—æ˜¯å¦å­˜åœ¨
    if 'æ²ªæ·±300æˆåˆ†è‚¡' in df.columns:
        cond10 = df['æ²ªæ·±300æˆåˆ†è‚¡'] == 'Y'
    else:
        # å¦‚æœåˆ—ä¸å­˜åœ¨ï¼Œé»˜è®¤æ‰€æœ‰è‚¡ç¥¨éƒ½ç¬¦åˆæ¡ä»¶
        cond10 = pd.Series([True] * len(df), index=df.index)

    common_filter = cond1 & cond2 & cond3 & cond4 & cond6 & cond7 & cond8 & cond9 & cond10
    df = df[common_filter]
    
    # åŸºäºæƒ…ç»ªå› å­è¿›è¡Œç­›é€‰ï¼šé€‰æ‹©æ¯ä¸ªäº¤æ˜“æ—¥æƒ…ç»ªå¾—åˆ†æœ€é«˜çš„100åªè‚¡ç¥¨

    df = df.sort_values(['äº¤æ˜“æ—¥æœŸ', 'æƒ…ç»ªå› å­'], ascending=[True, False])
    df = df.groupby('äº¤æ˜“æ—¥æœŸ').head(100)

    
    return df


def calc_timing_factor(df, strategy) -> pd.DataFrame:
    """
    è®¡ç®—æ‹©æ—¶ä¿¡å·
    :param df: æ•´ç†å¥½çš„æ•°æ®ï¼ŒåŒ…å«å› å­ä¿¡æ¯ï¼Œå¹¶åšè¿‡å‘¨æœŸè½¬æ¢
    :param strategy: ç­–ç•¥é…ç½®
    :return: è¿”å›åŒ…å«æ‹©æ—¶ä¿¡å·çš„æ•°æ®

    ### df åˆ—è¯´æ˜
    åŒ…å«åŸºç¡€åˆ—ï¼š  ['äº¤æ˜“æ—¥æœŸ', 'è‚¡ç¥¨ä»£ç ', 'è‚¡ç¥¨åç§°', 'ä¸Šå¸‚è‡³ä»Šäº¤æ˜“å¤©æ•°', 'å¤æƒå› å­', 'å¼€ç›˜ä»·', 'æœ€é«˜ä»·',
                'æœ€ä½ä»·', 'æ”¶ç›˜ä»·', 'æˆäº¤é¢', 'æ˜¯å¦äº¤æ˜“', 'æµé€šå¸‚å€¼', 'æ€»å¸‚å€¼', 'ä¸‹æ—¥_å¼€ç›˜æ¶¨åœ', 'ä¸‹æ—¥_æ˜¯å¦ST', 'ä¸‹æ—¥_æ˜¯å¦äº¤æ˜“',
                'ä¸‹æ—¥_æ˜¯å¦é€€å¸‚']
    ä»¥åŠconfigä¸­é…ç½®å¥½çš„ï¼Œå› å­è®¡ç®—çš„ç»“æœåˆ—ã€‚

    ### strategy æ•°æ®è¯´æ˜
    - strategy.name: ç­–ç•¥åç§°
    - strategy.timing_list: æ‹©æ—¶å› å­åˆ—è¡¨
    - strategy.filter_list: è¿‡æ»¤å› å­åˆ—è¡¨
    - strategy.factor_columns: æ‹©æ—¶+è¿‡æ»¤å› å­çš„åˆ—å
    """
    # ç›´æ¥ä»dfä¸­è·å–3ä¸ªæ‹©æ—¶å› å­çš„ä¿¡å·
    timing_signals = df[['MACD', 'RSI', 'VWMA']]
    
    # è®¡ç®—æ¯ä¸ªäº¤æ˜“æ—¥æ‹©æ—¶ä¿¡å·ä¸º1çš„æ•°é‡
    signal_count = timing_signals.sum(axis=1)
    
    # æ‹©æ—¶é€»è¾‘ï¼šæœ‰ä»»æ„2ä¸ªæ‹©æ—¶ä¿¡å·ä¸º1æ—¶ï¼Œæœ€ç»ˆæ‹©æ—¶ä¿¡å·ä¸º1ï¼Œå¦åˆ™ä¸º0
    df['æ‹©æ—¶ä¿¡å·'] = (signal_count >= 2).astype(int)
    
    return df
